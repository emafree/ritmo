# Internationalization (i18n) Guide

This document explains how to use the internationalization system in Ritmo.

## Overview

Ritmo uses [rust-i18n](https://github.com/longbridge/rust-i18n) for internationalization support. The system allows the application to display user-facing content in multiple languages.

**Currently Supported Languages:**
- English (en) - Default
- Italian (it)

## What Gets Translated

### ✅ DO Translate (User-Facing Content)

- CLI help text and command descriptions
- Runtime messages (success, errors, warnings)
- Error messages shown to users
- GUI labels, buttons, and text
- System value display names (roles, types, formats, language roles)

### ❌ DO NOT Translate (Developer Content)

- Code comments
- API documentation (`///` doc comments)
- Debug/trace log messages
- Variable, function, and struct names
- Translation keys themselves

## Directory Structure

```
ritmo/
├── locales/              # Translation files (YAML)
│   ├── en.yml           # English translations
│   ├── it.yml           # Italian translations
│   └── README.md        # Translation contributor guide
└── ritmo_db/
    └── src/
        └── i18n_utils.rs # Locale detection utilities
```

## Using i18n in Code

### 1. Initialize i18n in a Crate

Add rust-i18n dependency and initialize the macro in your crate's `lib.rs`:

```rust
// my_crate/Cargo.toml
[dependencies]
rust-i18n = { workspace = true }

// my_crate/src/lib.rs
rust_i18n::i18n!("../locales", fallback = "en");
```

### 2. Using the `t!()` Macro

The `t!()` macro translates a key to the current locale's string.

**Basic usage:**
```rust
use rust_i18n::t;

// Simple translation
let message = t!("cli.common.success");
// English: "✓ Operation completed successfully"
// Italian: "✓ Operazione completata con successo"
```

**With variable substitution:**
```rust
let message = t!("error.book.not_found", id = 42);
// English: "Book with ID 42 not found"
// Italian: "Libro con ID 42 non trovato"
```

**Multiple variables:**
```rust
let message = t!(
    "error.book.already_exists",
    path = "/path/to/book.epub",
    id = 123
);
// English: "File already imported: /path/to/book.epub (ID: 123)"
// Italian: "File già importato: /path/to/book.epub (ID: 123)"
```

**Important:** The `t!()` macro returns `Cow<str>`, not `String`. Convert to String when needed:

```rust
// Return as String
pub fn get_error_message() -> String {
    t!("error.book.not_found", id = 42).to_string()
}

// Use directly in format strings
println!("{}", t!("cli.common.success"));
```

### 3. Locale Management

The `ritmo_db::i18n_utils` module provides utilities for locale detection and switching:

```rust
use ritmo_db::i18n_utils::{init_i18n, set_locale, get_locale, detect_locale};

// Initialize i18n with auto-detected locale
// Call this early in main() or library init
init_i18n();

// Manually set locale
set_locale("it");  // Switch to Italian
set_locale("en");  // Switch to English

// Get current locale
let current = get_locale();  // Returns String (e.g., "en" or "it")

// Detect best locale from environment
let detected = detect_locale();  // Returns &'static str
```

### 4. Using the I18nDisplayable Trait

For models with i18n support, use the `I18nDisplayable` trait:

```rust
use ritmo_db::i18n_trait::I18nDisplayable;
use ritmo_db::Role;

let role = Role {
    id: Some(1),
    key: "role.author".to_string(),
    created_at: 1234567890,
};

// Use trait method directly
let translated = role.translate();

// Or use model's convenience method
let display_name = role.display_name();

// Both delegate to the same trait implementation
assert_eq!(translated, display_name);
```

See the "I18nDisplayable Trait" section below for complete details.

### 5. Locale Detection Priority

The `detect_locale()` function checks in this order:

1. **RITMO_LANG** environment variable (e.g., `RITMO_LANG=it`)
2. **LANG** environment variable (e.g., `LANG=it_IT.UTF-8` → "it")
3. **Default fallback** ("en")

```bash
# Force Italian locale
RITMO_LANG=it cargo run -p ritmo_cli -- list-books

# Use system locale
cargo run -p ritmo_cli -- list-books
```

## Translation File Format

Translation files use YAML format with nested keys:

```yaml
# locales/en.yml
db:
  role:
    author: "Author"
    translator: "Translator"

error:
  book:
    not_found: "Book with ID {id} not found"

cli:
  common:
    success: "✓ Operation completed successfully"
```

```yaml
# locales/it.yml
db:
  role:
    author: "Autore"
    translator: "Traduttore"

error:
  book:
    not_found: "Libro con ID {id} non trovato"

cli:
  common:
    success: "✓ Operazione completata con successo"
```

### Key Naming Convention

Use this pattern: `{namespace}.{category}.{subcategory}.{key}`

**Namespaces:**
- `cli.*` - Command-line interface
- `db.*` - Database system strings
- `error.*` - Error messages
- `gui.*` - GUI interface
- `validation.*` - Input validation

**Examples:**
- `cli.app.description` - CLI application description
- `db.role.author` - Author role display name
- `error.book.not_found` - Book not found error
- `gui.sidebar.books` - Books sidebar label
- `validation.date_format` - Date validation error

## Complete Example

### Step 1: Add Translation Keys

```yaml
# locales/en.yml
cli:
  book:
    import:
      success: "✓ Book imported successfully!"
      progress: "Importing book: {title}"

error:
  import:
    failed: "Import failed: {reason}"
```

```yaml
# locales/it.yml
cli:
  book:
    import:
      success: "✓ Libro importato con successo!"
      progress: "Importazione libro: {title}"

error:
  import:
    failed: "Importazione fallita: {reason}"
```

### Step 2: Use in Code

```rust
use rust_i18n::t;
use ritmo_db::i18n_utils::init_i18n;

fn import_book(title: &str) -> Result<(), String> {
    // Initialize i18n (typically in main)
    init_i18n();

    // Show progress
    println!("{}", t!("cli.book.import.progress", title = title));

    // Simulate import
    if let Err(e) = do_import(title) {
        return Err(t!("error.import.failed", reason = e).to_string());
    }

    // Show success
    println!("{}", t!("cli.book.import.success"));
    Ok(())
}
```

### Step 3: Run with Different Locales

```bash
# English (default)
$ cargo run
Importing book: My Book
✓ Book imported successfully!

# Italian
$ RITMO_LANG=it cargo run
Importazione libro: My Book
✓ Libro importato con successo!
```

## I18nDisplayable Trait

All models with i18n support implement the `I18nDisplayable` trait, which provides a consistent interface for translation:

```rust
/// Trait for models that have i18n-translatable keys
pub trait I18nDisplayable {
    /// Returns the canonical i18n key for this model instance
    fn i18n_key(&self) -> &str;

    /// Returns the namespace prefix for translation keys (default: "db")
    fn i18n_namespace(&self) -> &str {
        "db"
    }

    /// Translates the i18n key to a localized string
    fn translate(&self) -> String {
        use rust_i18n::t;
        let translation_key = format!("{}.{}", self.i18n_namespace(), self.i18n_key());
        t!(&translation_key).to_string()
    }
}
```

### Benefits of the Trait

1. **Code Reuse**: Eliminates duplication across models
2. **Consistency**: Ensures all models translate the same way
3. **Type Safety**: Enables generic functions that work with any translatable model
4. **Maintainability**: Centralized translation logic in one place

### Using the Trait

Models implement the trait by providing their i18n key:

```rust
// Role implementation
impl I18nDisplayable for Role {
    fn i18n_key(&self) -> &str {
        &self.key  // "role.author"
    }
}

// RunningLanguages implementation
impl I18nDisplayable for RunningLanguages {
    fn i18n_key(&self) -> &str {
        &self.role  // "language_role.original"
    }
}
```

The trait automatically handles translation using the `translate()` method:

```rust
let role = Role {
    id: Some(1),
    key: "role.author".to_string(),
    created_at: 1234567890,
};

set_locale("en");
assert_eq!(role.translate(), "Author");

set_locale("it");
assert_eq!(role.translate(), "Autore");
```

### Model Display Names Example

Models provide convenience methods that delegate to the trait:

```rust
// ritmo_db/src/models/roles.rs
impl Role {
    pub fn display_name(&self) -> String {
        self.translate()  // Delegates to I18nDisplayable trait
    }
}

// Usage
let role = Role {
    id: Some(1),
    key: "role.author".to_string(),
    created_at: 1234567890,
};

set_locale("en");
assert_eq!(role.display_name(), "Author");

set_locale("it");
assert_eq!(role.display_name(), "Autore");
```

### Generic Functions

The trait enables writing generic functions that work with any translatable model:

```rust
fn get_translation<T: I18nDisplayable>(item: &T) -> String {
    item.translate()
}

let role = Role { key: "role.author".to_string(), ... };
let lang = RunningLanguages { role: "language_role.original".to_string(), ... };

println!("{}", get_translation(&role));  // "Author"
println!("{}", get_translation(&lang));  // "Original Language"
```

## Adding a New Language

1. **Create translation file:**
   ```bash
   cp locales/en.yml locales/fr.yml
   ```

2. **Translate all values** (keep keys in English):
   ```yaml
   # locales/fr.yml
   cli:
     common:
       success: "✓ Opération terminée avec succès"
   ```

3. **Update `SUPPORTED_LOCALES`** in `ritmo_db/src/i18n_utils.rs`:
   ```rust
   pub const SUPPORTED_LOCALES: &[&str] = &["en", "it", "fr"];
   ```

4. **Update documentation:**
   - `locales/README.md`
   - This file (`docs/i18n.md`)

5. **Test the new language:**
   ```bash
   RITMO_LANG=fr cargo run -p ritmo_cli -- list-books
   ```

## Testing i18n

Write tests to verify translations work correctly:

```rust
#[test]
fn test_role_translation() {
    use ritmo_db::i18n_utils::set_locale;
    use ritmo_db::Role;

    let role = Role {
        id: Some(1),
        key: "role.author".to_string(),
        created_at: 1234567890,
    };

    set_locale("en");
    assert_eq!(role.display_name(), "Author");

    set_locale("it");
    assert_eq!(role.display_name(), "Autore");
}
```

**Note:** Run i18n tests with `--test-threads=1` to avoid race conditions:

```bash
cargo test --package ritmo_db --test i18n_integration_test -- --test-threads=1
```

## Current Translation Coverage

See `locales/README.md` for the current list of translated keys.

**Initial coverage:** ~54 keys
**Remaining:** ~500 keys (to be added progressively)

## Best Practices

1. **Always add keys to ALL language files** - Missing keys fall back to the key name
2. **Use descriptive keys** - `error.book.not_found` not `err.bk.nf`
3. **Keep consistent terminology** - Use the same term across translations
4. **Test both languages** - Verify translations work in actual context
5. **Initialize early** - Call `init_i18n()` in main() before any t!() calls
6. **Document new namespaces** - Update this guide when adding new key patterns

## Troubleshooting

### Translation not appearing

**Check:**
1. Is the key present in BOTH language files?
2. Is the key path correct? (check case sensitivity)
3. Did you call `init_i18n()` or set a locale?
4. Is the YAML file properly formatted? (use a YAML validator)

### Wrong language showing

**Check:**
1. What does `get_locale()` return?
2. Are environment variables set? (`RITMO_LANG`, `LANG`)
3. Did you call `set_locale()` after initialization?

### Type mismatch errors

**Remember:**
- `t!()` returns `Cow<str>`, not `String`
- Convert with `.to_string()` when needed
- Or use `&*t!(...)` to get `&str`

## Future Improvements

- [ ] Add more languages (French, Spanish, German, etc.)
- [ ] GUI language switcher
- [ ] Pluralization support
- [ ] Date/time localization
- [ ] Number formatting
- [ ] Translation completeness checker
- [ ] Automatic translation file validation

## References

- [rust-i18n Documentation](https://github.com/longbridge/rust-i18n)
- [YAML Syntax Guide](https://yaml.org/)
- [Translation Keys](../locales/README.md)
